---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import { Image } from "astro:assets";

type Props = CollectionEntry<"blog">["data"];

const {
	title,
	description,
	summary,
	date,
	pubDate,
	updatedDate,
	heroImage,
	tags,
	draft,
} = Astro.props;

// Use new 'date' field, fallback to 'pubDate' for backwards compatibility
const postDate = date || pubDate;
const postDescription = summary || description;
---

<html lang="en">
	<head>
		<BaseHead
			title={title}
			description={postDescription ?? ''}
			article={{
				publishedTime: postDate?.toISOString(),
				modifiedTime: updatedDate?.toISOString(),
				author: 'Adrian Villanueva Martinez',
				tags: tags,
			}}
		/>
		<style>
			.blog-container {
				max-width: 780px;
				margin: 0 auto;
				padding: 3rem 2rem;
			}

			/* Back link */
			.back-link {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				color: var(--text-muted);
				text-decoration: none;
				font-size: 0.875rem;
				margin-bottom: 4rem;
				transition: all 0.2s ease;
				font-family: "JetBrains Mono", monospace;
			}

			.back-link:hover {
				color: var(--accent-active);
				transform: translateX(-4px);
			}

			.back-link::before {
				content: '←';
				transition: transform 0.2s ease;
			}

			/* Draft banner */
			.draft-banner {
				background: rgba(255, 157, 0, 0.1);
				border: 1px solid var(--accent-warning);
				padding: 1rem 1.5rem;
				margin-bottom: 2rem;
				border-radius: var(--radius-sm);
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.draft-icon {
				font-size: 1.2rem;
				line-height: 1;
			}

			.draft-text {
				color: var(--text-primary);
				font-family: "JetBrains Mono", monospace;
				font-size: 0.9rem;
				line-height: 1.5;
			}

			.draft-text strong {
				color: var(--accent-warning);
				font-weight: 700;
			}

			/* Header section */
			.post-header {
				margin-bottom: 4rem;
				padding-bottom: 2.5rem;
				border-bottom: 1px solid var(--border-color);
			}

			.blog-title {
				font-size: clamp(2rem, 5vw, 3rem);
				font-weight: 700;
				color: var(--text-primary);
				margin-bottom: 1.5rem;
				line-height: 1.2;
				letter-spacing: -0.03em;
				font-family: "JetBrains Mono", monospace;
			}

			.description {
				font-size: 1.2rem;
				color: var(--text-secondary);
				line-height: 1.6;
				margin-bottom: 1.5rem;
				font-weight: 400;
			}

			.blog-meta {
				display: flex;
				align-items: center;
				gap: 1rem;
				flex-wrap: wrap;
				font-size: 0.875rem;
				margin-bottom: 1rem;
			}

			.date {
				color: var(--text-muted);
				font-family: "JetBrains Mono", monospace;
			}

			.updated-date {
				color: var(--text-muted);
				font-family: "JetBrains Mono", monospace;
			}

			.updated-date::before {
				content: '•';
				margin-right: 1rem;
				color: var(--text-muted);
			}

			/* Tags styling */
			.tags-container {
				display: flex;
				gap: 0.5rem;
				flex-wrap: wrap;
				margin-top: 1.5rem;
			}

			.tag {
				display: inline-block;
				padding: 0.25rem 0.75rem;
				background: var(--bg-secondary);
				border: 1px solid var(--border-color);
				color: var(--text-secondary);
				font-size: 0.8rem;
				font-family: "JetBrains Mono", monospace;
				text-decoration: none;
				transition: all 0.2s ease;
				border-radius: var(--radius-sm);
			}

			.tag:hover {
				border-color: var(--accent-active);
				color: var(--accent-active);
			}

			.tag::before {
				content: '#';
				opacity: 0.5;
				margin-right: 0.125rem;
			}

			/* Hero image */
			.hero-image {
				width: 100%;
				margin-bottom: 3rem;
				border: 1px solid var(--border-color);
				border-radius: var(--radius-md);
				overflow: hidden;
			}

			.hero-image img {
				width: 100%;
				height: auto;
				display: block;
			}

			/* Article content */
			.prose {
				line-height: 1.8;
				color: var(--text-secondary);
				font-size: 1.1rem;
				font-family: 'Inter', sans-serif;
			}

			.prose > * + * {
				margin-top: 1.75rem;
			}

			/* First paragraph - make it stand out */
			.prose > p:first-of-type {
				font-size: 1.2rem;
				line-height: 1.7;
				color: var(--text-primary);
				margin-bottom: 2rem;
			}

			.prose h1,
			.prose h2,
			.prose h3,
			.prose h4,
			.prose h5,
			.prose h6 {
				color: var(--text-primary);
				margin-top: 3rem;
				margin-bottom: 1.25rem;
				line-height: 1.3;
				font-weight: 700;
				font-family: "JetBrains Mono", monospace;
				letter-spacing: -0.02em;
			}

			.prose h1 {
				font-size: 2.25rem;
				margin-top: 4rem;
			}

			.prose h2 {
				font-size: 1.75rem;
				padding-bottom: 0.5rem;
				border-bottom: 1px solid var(--border-color);
			}

			.prose h3 {
				font-size: 1.4rem;
			}

			.prose h4 {
				font-size: 1.2rem;
			}

			.prose p {
				margin: 1.5rem 0;
			}

			.prose a {
				color: var(--text-primary);
				text-decoration: none;
				border-bottom: 1px solid var(--accent-active);
				transition: all 0.2s ease;
			}

			.prose a:hover {
				background: var(--accent-active);
				color: var(--bg-primary);
			}

			.prose strong {
				color: var(--text-primary);
				font-weight: 600;
			}

			.prose em {
				font-style: italic;
				color: var(--text-primary);
			}

			.prose code {
				background: var(--bg-tertiary);
				color: var(--text-primary);
				padding: 0.2em 0.4em;
				border-radius: 4px;
				font-size: 0.85em;
				font-family: "JetBrains Mono", monospace;
				border: 1px solid var(--border-color);
			}

			.prose pre {
				background: var(--bg-tertiary);
				border: 1px solid var(--border-color);
				padding: 1.5rem;
				overflow-x: auto;
				border-radius: var(--radius-md);
				margin: 2rem 0;
			}

			.prose pre code {
				background: none;
				padding: 0;
				border: none;
				font-size: 0.9rem;
				line-height: 1.6;
				color: var(--text-secondary);
			}

			.prose blockquote {
				border-left: 3px solid var(--accent-info);
				padding-left: 1.5rem;
				margin: 2rem 0;
				font-style: italic;
				color: var(--text-primary);
				background: var(--bg-secondary);
				padding: 1.5rem;
				border-radius: 0 var(--radius-md) var(--radius-md) 0;
			}

			.prose blockquote p {
				margin: 0;
			}

			.prose ul,
			.prose ol {
				margin: 1.5rem 0;
				padding-left: 1.5rem;
			}

			.prose li {
				margin-bottom: 0.5rem;
				color: var(--text-secondary);
			}

			.prose li::marker {
				color: var(--text-muted);
			}

			.prose hr {
				border: none;
				border-top: 1px solid var(--border-color);
				margin: 3rem 0;
			}

			.prose img {
				max-width: 100%;
				height: auto;
				border: 1px solid var(--border-color);
				margin: 2rem auto;
				display: block;
				border-radius: var(--radius-md);
			}

			/* SVG images (d2 diagrams) */
			.prose img[src$='.svg'] {
				background: white;
				padding: 1rem;
			}

			.prose table {
				width: 100%;
				border-collapse: collapse;
				margin: 2rem 0;
				font-size: 0.9rem;
			}

			.prose th,
			.prose td {
				border: 1px solid var(--border-color);
				padding: 0.75rem;
				text-align: left;
			}

			.prose th {
				background: var(--bg-secondary);
				color: var(--text-primary);
				font-weight: 600;
				font-family: "JetBrains Mono", monospace;
				font-size: 0.8rem;
				text-transform: uppercase;
			}

			.prose td {
				background: var(--bg-primary);
			}

			/* Responsive */
			@media (max-width: 768px) {
				.blog-container {
					padding: 2rem 1rem;
				}

				.blog-title {
					font-size: 2rem;
				}

				.prose {
					font-size: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<article class="blog-container">
				<a href="/blog" class="back-link">Back to Blog</a>

				<header class="post-header">
					{
						draft && (
							<div class="draft-banner">
								<span class="draft-icon">⚠️</span>
								<span class="draft-text">
									This is a <strong>DRAFT</strong> post and
									may not be finalized
								</span>
							</div>
						)
					}
					<h1 class="blog-title">{title}</h1>
					{
						postDescription && (
							<p class="description">{postDescription}</p>
						)
					}
					<div class="blog-meta">
						{
							postDate && (
								<time
									class="date"
									datetime={postDate.toISOString()}
								>
									<FormattedDate date={postDate} />
								</time>
							)
						}
						{
							updatedDate && (
								<time
									class="updated-date"
									datetime={updatedDate.toISOString()}
								>
									Updated <FormattedDate date={updatedDate} />
								</time>
							)
						}
					</div>
					{
						tags && tags.length > 0 && (
							<div class="tags-container">
								{tags.map((tag) => (
									<span class="tag">{tag}</span>
								))}
							</div>
						)
					}
				</header>

				{
					heroImage && (
						<div class="hero-image">
							<Image
								width={720}
								height={405}
								src={heroImage}
								alt={title}
							/>
						</div>
					)
				}

				<div class="prose">
					<slot />
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>
